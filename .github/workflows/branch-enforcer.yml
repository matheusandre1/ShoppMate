name: External PR Branch Enforcer

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  issues: write
  contents: write

jobs:
  check-target-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR target branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const pr = context.payload.pull_request;
              const targetBranch = pr.base.ref;
              const sourceBranch = pr.head.ref;
              const author = pr.user.login;
              const association = pr.author_association;
              
              const isOwner = association === 'OWNER';

              // Rule: Only Owner can target 'main', and it MUST come from 'develop'
              if (targetBranch === 'main') {
                if (!isOwner || sourceBranch !== 'develop') {
                  console.log(`‚ö†Ô∏è Redirecting PR #${pr.number} from ${targetBranch} to develop. Reason: Restricted access or invalid source branch.`);
                  
                  let message = `ü§ñ **Attention @${author}!** `;
                  if (!isOwner) {
                    message += `Only the repository owner can target the 'main' branch directly.`;
                  } else {
                    message += `To maintain a clean history, PRs to 'main' must originate from the 'develop' branch.`;
                  }
                  message += ` I've automatically updated your PR to target 'develop' instead. Thank you! üöÄ`;

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: message
                  });
                  
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    base: 'develop'
                  });
                }
              }
            } catch (error) {
              console.error("‚ùå Error processing branch enforcement:", error);
            }
